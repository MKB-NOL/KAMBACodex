<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KAMBA Codex - Admin</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
  <script src="https://unpkg.com/@codemirror/view@6.33.0/dist/index.js"></script>
  <script src="https://unpkg.com/@codemirror/state@6.4.1/dist/index.js"></script>
  <script src="https://unpkg.com/@codemirror/language@6.10.3/dist/index.js"></script>
  <script src="https://unpkg.com/@codemirror/lang-html@6.4.9/dist/index.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: linear-gradient(to bottom, #f5f7fa, #e0e7ff);
    }
    .admin-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }
    .cm-editor {
      height: 200px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      font-size: 14px;
    }
    .snippet-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(8px);
    }
    .snippet-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    .traffic-lights {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .traffic-light {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .traffic-light.red { background: #ff5f56; }
    .traffic-light.yellow { background: #ffbd2e; }
    .traffic-light.green { background: #27c93f; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fadeIn 0.5s ease-out;
    }
  </style>
</head>
<body class="min-h-screen">
  <header class="bg-white/95 backdrop-filter backdrop-blur-lg py-3 sticky top-0 z-10 shadow-sm">
    <div class="container mx-auto px-4 flex items-center justify-between">
      <div class="flex items-center">
        <div class="traffic-lights mr-3">
          <div class="traffic-light red"></div>
          <div class="traffic-light yellow"></div>
          <div class="traffic-light green"></div>
        </div>
        <img src="logo.png" alt="KAMBA Codex Logo" class="h-10 mr-3">
        <h1 class="text-xl font-bold text-gray-900">KAMBA Codex - Admin</h1>
      </div>
      <button
        id="logoutBtn"
        class="px-3 py-1.5 bg-red-500 text-white rounded-full text-xs font-medium hover:bg-red-600 transition"
      >
        Log Out
      </button>
    </div>
  </header>
  <main class="container mx-auto px-4 py-12">
    <section class="admin-container p-6 max-w-2xl mx-auto animate-fade-in mb-12">
      <h2 id="formTitle" class="text-xl font-bold text-gray-900 mb-6">Add New Snippet</h2>
      <div class="space-y-4">
        <input
          type="text"
          id="title"
          placeholder="Snippet Title"
          class="w-full p-2.5 rounded-full border border-gray-200 bg-white/80 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm"
        />
        <div class="flex space-x-4">
          <div>
            <label for="bgColor" class="text-xs font-medium text-gray-700">Editor Background:</label>
            <input
              type="color"
              id="bgColor"
              value="#ffffff"
              class="w-12 h-8 p-0 border-none rounded cursor-pointer"
            />
          </div>
          <div>
            <label for="textColor" class="text-xs font-medium text-gray-700">Editor Text:</label>
            <input
              type="color"
              id="textColor"
              value="#000000"
              class="w-12 h-8 p-0 border-none rounded cursor-pointer"
            />
          </div>
        </div>
        <textarea
          id="code"
          placeholder="Paste or type code here..."
          class="w-full p-2.5 rounded-xl border border-gray-200 bg-white/80 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm h-32 hidden"
        ></textarea>
        <div id="codeEditor"></div>
        <textarea
          id="description"
          placeholder="Description"
          class="w-full p-2.5 rounded-xl border border-gray-200 bg-white/80 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm h-24"
        ></textarea>
        <input
          type="text"
          id="youtubeLink"
          placeholder="YouTube Link (e.g., https://www.youtube.com/watch?v=...)"
          class="w-full p-2.5 rounded-full border border-gray-200 bg-white/80 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm"
        />
        <div id="imageInputs" class="space-y-2">
          <div class="flex space-x-2">
            <input
              type="text"
              class="image-url w-full p-2.5 rounded-full border border-gray-200 bg-white/80 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm"
              placeholder="Image URL"
            />
            <button
              class="remove-image px-3 py-1.5 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 transition"
            >
              Remove
            </button>
          </div>
        </div>
        <button
          id="addImageBtn"
          class="px-3 py-1.5 bg-gray-200 text-gray-800 rounded-full text-xs font-medium hover:bg-gray-300 transition"
        >
          Add Another Image
        </button>
        <input type="hidden" id="editId" value="">
        <button
          id="submitBtn"
          class="w-full px-3 py-1.5 bg-blue-500 text-white rounded-full text-xs font-medium hover:bg-blue-600 transition"
        >
          Add Snippet
        </button>
      </div>
    </section>
    <section class="admin-container p-6 max-w-2xl mx-auto animate-fade-in">
      <h2 class="text-xl font-bold text-gray-900 mb-6">Posted Snippets</h2>
      <div id="postedSnippets" class="space-y-4"></div>
    </section>
  </main>

  <script>
    // Load Firebase dependencies
    const firebaseScript = document.createElement('script');
    firebaseScript.src = 'https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js';
    document.head.appendChild(firebaseScript);

    firebaseScript.onload = () => {
      const authScript = document.createElement('script');
      authScript.src = 'https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js';
      document.head.appendChild(authScript);

      const firestoreScript = document.createElement('script');
      firestoreScript.src = 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';
      document.head.appendChild(firestoreScript);

      firestoreScript.onload = () => {
        initializeApp();
      };
    };

    function initializeApp() {
      const { initializeApp } = firebase;
      const { getAuth, signOut, onAuthStateChanged } = firebase.auth;
      const { getFirestore, collection, addDoc, getDocs, updateDoc, doc } = firebase.firestore;

      const firebaseConfig = {
        apiKey: "AIzaSyCW2RJIku0JLJZTUu0YA9yKO8zjtX29fAo",
        authDomain: "muah-feed.firebaseapp.com",
        databaseURL: "https://muah-feed-default-rtdb.firebaseio.com",
        projectId: "muah-feed",
        storageBucket: "muah-feed.firebasestorage.app",
        messagingSenderId: "442314397706",
        appId: "1:442314397706:web:a69e3958257fb13b3667f3",
        measurementId: "G-S86S229F1T"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Initialize CodeMirror
      let editor;
      const codeTextarea = document.getElementById('code');
      const bgColorInput = document.getElementById('bgColor');
      const textColorInput = document.getElementById('textColor');

      // Load saved colors from localStorage
      const savedBgColor = localStorage.getItem('editorBgColor') || '#ffffff';
      const savedTextColor = localStorage.getItem('editorTextColor') || '#000000';
      bgColorInput.value = savedBgColor;
      textColorInput.value = savedTextColor;

      function initEditor(value = '') {
        if (editor) editor.destroy();
        editor = new CodeMirror.view.EditorView({
          doc: value,
          extensions: [
            CodeMirror.view.basicSetup,
            CodeMirror.lang.html(),
            CodeMirror.view.EditorView.updateListener.of((update) => {
              if (update.docChanged) {
                codeTextarea.value = update.state.doc.toString();
              }
            })
          ],
          parent: document.getElementById('codeEditor')
        });

        // Apply custom colors
        updateEditorColors();

        // Handle paste events for images
        editor.dom.addEventListener('paste', async (event) => {
          const items = (event.clipboardData || event.originalEvent.clipboardData).items;
          for (const item of items) {
            if (item.type.indexOf('image') !== -1) {
              event.preventDefault();
              const file = item.getAsFile();
              const reader = new FileReader();
              reader.onload = (e) => {
                const base64Image = e.target.result;
                const imgTag = `<img src="${base64Image}" style="max-width: 100px; margin: 5px;" />`;
                const currentContent = editor.state.doc.toString();
                editor.dispatch({
                  changes: { from: currentContent.length, insert: imgTag }
                });
                codeTextarea.value = editor.state.doc.toString();
              };
              reader.readAsDataURL(file);
            }
          }
        });
      }

      function updateEditorColors() {
        const editorDom = document.querySelector('.cm-editor');
        if (editorDom) {
          editorDom.style.backgroundColor = bgColorInput.value;
          editorDom.style.color = textColorInput.value;
          localStorage.setItem('editorBgColor', bgColorInput.value);
          localStorage.setItem('editorTextColor', textColorInput.value);
        }
      }

      bgColorInput.addEventListener('input', updateEditorColors);
      textColorInput.addEventListener('input', updateEditorColors);

      try {
        initEditor();
      } catch (error) {
        console.error('CodeMirror initialization failed:', error);
        alert('Failed to load code editor. Please try refreshing the page.');
      }

      // Check authentication state
      onAuthStateChanged(auth, user => {
        if (!user) window.location.href = 'index.html';
      });

      // Logout
      document.getElementById('logoutBtn').addEventListener('click', () => {
        signOut(auth).then(() => {
          window.location.href = 'index.html';
        }).catch(error => alert('Logout failed: ' + error.message));
      });

      // Dynamic image inputs
      document.getElementById('addImageBtn').addEventListener('click', () => {
        const imageInputs = document.getElementById('imageInputs');
        const newInput = document.createElement('div');
        newInput.className = 'flex space-x-2';
        newInput.innerHTML = `
          <input
            type="text"
            class="image-url w-full p-2.5 rounded-full border border-gray-200 bg-white/80 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm"
            placeholder="Image URL"
          />
          <button
            class="remove-image px-3 py-1.5 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 transition"
          >
            Remove
          </button>
        `;
        imageInputs.appendChild(newInput);
        newInput.querySelector('.remove-image').addEventListener('click', () => {
          if (imageInputs.children.length > 1) newInput.remove();
        });
      });

      // Render posted snippets
      async function renderPostedSnippets() {
        const postedSnippets = document.getElementById('postedSnippets');
        postedSnippets.innerHTML = '';
        try {
          const querySnapshot = await getDocs(collection(db, 'snippets'));
          querySnapshot.forEach(doc => {
            const snippet = { id: doc.id, ...doc.data() };
            const card = document.createElement('div');
            card.className = 'snippet-card p-4 rounded-xl bg-white/90 border border-gray-200 cursor-pointer';
            card.innerHTML = `
              <div class="flex items-center">
                <img src="${snippet.images[0] || ''}" alt="${snippet.title}" class="w-12 h-12 rounded-xl mr-3">
                <div>
                  <h3 class="text-base font-semibold text-gray-900">${snippet.title}</h3>
                  <p class="text-xs text-gray-500">Mixed Code</p>
                </div>
              </div>
            `;
            card.addEventListener('click', () => {
              document.getElementById('formTitle').textContent = 'Edit Snippet';
              document.getElementById('submitBtn').textContent = 'Update Snippet';
              document.getElementById('editId').value = snippet.id;
              document.getElementById('title').value = snippet.title;
              codeTextarea.value = snippet.code;
              initEditor(snippet.code);
              document.getElementById('description').value = snippet.description;
              document.getElementById('youtubeLink').value = snippet.youtubeLink || '';
              const imageInputs = document.getElementById('imageInputs');
              imageInputs.innerHTML = '';
              snippet.images.forEach(url => {
                const inputDiv = document.createElement('div');
                inputDiv.className = 'flex space-x-2';
                inputDiv.innerHTML = `
                  <input
                    type="text"
                    class="image-url w-full p-2.5 rounded-full border border-gray-200 bg-white/80 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm"
                    value="${url}"
                  />
                  <button
                    class="remove-image px-3 py-1.5 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 transition"
                  >
                    Remove
                  </button>
                `;
                imageInputs.appendChild(inputDiv);
                inputDiv.querySelector('.remove-image').addEventListener('click', () => {
                  if (imageInputs.children.length > 1) inputDiv.remove();
                });
              });
            });
            postedSnippets.appendChild(card);
          });
        } catch (error) {
          console.error('Error fetching snippets:', error);
          alert('Failed to load snippets. Please try again.');
        }
      }

      // Submit or update snippet
      document.getElementById('submitBtn').addEventListener('click', async () => {
        const title = document.getElementById('title').value;
        const code = editor.state.doc.toString();
        const description = document.getElementById('description').value;
        const youtubeLink = document.getElementById('youtubeLink').value;
        const images = Array.from(document.querySelectorAll('.image-url')).map(input => input.value).filter(url => url);
        const editId = document.getElementById('editId').value;

        // Extract base64 images from code
        const parser = new DOMParser();
        const doc = parser.parseFromString(code, 'text/html');
        const pastedImages = Array.from(doc.querySelectorAll('img')).map(img => img.src).filter(src => src.startsWith('data:image/'));

        if (!title || !code || !description || !images.length) {
          alert('Please fill in all required fields.');
          return;
        }

        try {
          if (editId) {
            await updateDoc(doc(db, 'snippets', editId), {
              title,
              code,
              description,
              youtubeLink,
              images,
              pastedImages
            });
            alert('Snippet updated successfully!');
          } else {
            await addDoc(collection(db, 'snippets'), {
              title,
              code,
              description,
              youtubeLink,
              images,
              pastedImages
            });
            alert('Snippet added successfully!');
          }
          document.getElementById('formTitle').textContent = 'Add New Snippet';
          document.getElementById('submitBtn').textContent = 'Add Snippet';
          document.getElementById('editId').value = '';
          document.getElementById('title').value = '';
          codeTextarea.value = '';
          initEditor('');
          document.getElementById('description').value = '';
          document.getElementById('youtubeLink').value = '';
          const imageInputs = document.getElementById('imageInputs');
          imageInputs.innerHTML = `
            <div class="flex space-x-2">
              <input
                type="text"
                class="image-url w-full p-2.5 rounded-full border border-gray-200 bg-white/80 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm"
                placeholder="Image URL"
              />
              <button
                class="remove-image px-3 py-1.5 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 transition"
              >
                Remove
              </button>
            </div>
          `;
          imageInputs.querySelector('.remove-image').addEventListener('click', () => {
            if (imageInputs.children.length > 1) imageInputs.children[0].remove();
          });
          await renderPostedSnippets();
        } catch (error) {
          console.error('Error saving snippet:', error);
          alert('Error saving snippet: ' + error.message);
        }
      });

      // Initial render of posted snippets
      renderPostedSnippets();

      // Remove image input event listeners
      document.addEventListener('click', e => {
        if (e.target.classList.contains('remove-image') && document.querySelectorAll('#imageInputs .flex').length > 1) {
          e.target.parentElement.remove();
        }
      });
    }
  </script>
</body>
</html>
