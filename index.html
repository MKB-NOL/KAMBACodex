<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KAMBA Codex - YouTube Subscription Check</title>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f4f8;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      flex-direction: column;
    }
    #status {
      margin-top: 20px;
      font-size: 1.2em;
    }
    button {
      background: #4285f4;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #357ae8;
    }
  </style>
</head>
<body>

  <h1>KAMBA Codex</h1>
  <button id="googleSignInBtn">Sign in with Google</button>
  <div id="status"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCW2RJIku0JLJZTUu0YA9yKO8zjtX29fAo",
      authDomain: "muah-feed.firebaseapp.com",
      projectId: "muah-feed",
      storageBucket: "muah-feed.appspot.com",
      messagingSenderId: "442314397706",
      appId: "1:442314397706:web:a69e3958257fb13b3667f3"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Your YouTube API key and Channel ID
    const YOUTUBE_API_KEY = "AIzaSyDIlI5PFdtwB1MUeTlZ9u3DgPLLU3Ewp5A";
    const CHANNEL_ID = "UCQAzVCSTT7LVU6BZ460Dvew";

    const statusDiv = document.getElementById("status");
    const googleSignInBtn = document.getElementById("googleSignInBtn");

    const provider = new GoogleAuthProvider();
    provider.addScope("https://www.googleapis.com/auth/youtube.readonly");

    async function checkSubscription(accessToken) {
      statusDiv.textContent = "Checking subscription status...";
      const url = `https://www.googleapis.com/youtube/v3/subscriptions?part=snippet&forChannelId=${CHANNEL_ID}&mine=true&key=${YOUTUBE_API_KEY}`;

      try {
        const response = await fetch(url, {
          headers: {
            Authorization: `Bearer ${accessToken}`,
            Accept: 'application/json'
          }
        });
        const data = await response.json();
        // Check if user is subscribed (data.items array non-empty)
        return data.items && data.items.length > 0;
      } catch (error) {
        console.error("Error checking subscription:", error);
        return false;
      }
    }

    googleSignInBtn.addEventListener("click", async () => {
      try {
        statusDiv.textContent = "Signing in with Google...";
        const result = await signInWithPopup(auth, provider);

        const credential = GoogleAuthProvider.credentialFromResult(result);
        const accessToken = credential.accessToken;

        if (!accessToken) {
          throw new Error("No access token available.");
        }

        const subscribed = await checkSubscription(accessToken);
        if (subscribed) {
          statusDiv.textContent = "üéâ You are subscribed! Access granted.";
          // TODO: Redirect or unlock content here
        } else {
          statusDiv.textContent = "‚ö†Ô∏è You are NOT subscribed. Please subscribe to proceed.";
        }
      } catch (error) {
        console.error(error);
        statusDiv.textContent = `Error: ${error.message}`;
      }
    });
  </script>
</body>
</html>
